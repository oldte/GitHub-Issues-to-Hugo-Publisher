name: GitHub Issues to Hugo Publisher

on:
  issues:
    types: [opened]
  workflow_dispatch:

permissions:
  contents: write  # å…è®¸å†™å…¥å†…å®¹

concurrency:
  group: "issues-to-hugo"
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  convert_issues:
    name: è½¬æ¢Issuesä¸ºHugoå†…å®¹
    runs-on: ubuntu-latest
    # è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘æˆ–å¸¦"å‘å¸ƒ"æ ‡ç­¾çš„æ–°Issue
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'issues' && 
       contains(github.event.issue.labels.*.name, 'å‘å¸ƒ') && 
       github.actor != 'actions-user')
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests PyGithub beautifulsoup4

      - name: åˆ›å»ºå†…å®¹ç›®å½•
        run: |
          mkdir -p content/posts
          echo "ç›®å½•å·²åˆ›å»º"

      - name: è½¬æ¢Issues
        id: convert
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨PAT_TOKENè®¤è¯
        run: |
          # è®°å½•åŸå§‹æ–‡ä»¶çŠ¶æ€
          find content/posts -type f 2>/dev/null | sort > /tmp/original_files.txt || touch /tmp/original_files.txt
          if [ -s /tmp/original_files.txt ]; then
            xargs sha1sum < /tmp/original_files.txt > /tmp/original_hashes.txt
          else
            touch /tmp/original_hashes.txt
          fi
          
          # æ‰§è¡Œè½¬æ¢è„šæœ¬
          python scripts/issue_to_hugo.py \
            --repo "${{ github.repository }}" \
            --output "content/posts" \
            --debug
          
          # è®°å½•è½¬æ¢åæ–‡ä»¶çŠ¶æ€
          find content/posts -type f 2>/dev/null | sort > /tmp/new_files.txt || touch /tmp/new_files.txt
          if [ -s /tmp/new_files.txt ]; then
            xargs sha1sum < /tmp/new_files.txt > /tmp/new_hashes.txt
          else
            touch /tmp/new_hashes.txt
          fi
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å˜åŒ–
          if cmp -s /tmp/original_hashes.txt /tmp/new_hashes.txt; then
            echo "needs_build=false" >> $GITHUB_OUTPUT
            echo "âœ… æ— å†…å®¹å˜æ›´"
          else
            echo "needs_build=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ æ£€æµ‹åˆ°å†…å®¹å˜æ›´"
          fi
          
      - name: æäº¤å˜æ›´
        if: steps.convert.outputs.needs_build == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --global user.name "Hugo Publisher"
          git config --global user.email "actions@users.noreply.github.com"
          
          # è®¾ç½®è¿œç¨‹ä»“åº“URL
          git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git
          
          # ç¡®å®šé»˜è®¤åˆ†æ”¯
          if [ -n "${{ github.base_ref }}" ]; then
            DEFAULT_BRANCH="${{ github.base_ref }}"
          else
            DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          fi
          
          # å›é€€åˆ°é»˜è®¤åˆ†æ”¯
          git checkout $DEFAULT_BRANCH
          
          # æ·»åŠ å¹¶æäº¤å˜æ›´
          git add content/posts
          
          if ! git diff-index --quiet HEAD --; then
            git commit -m "è‡ªåŠ¨æ›´æ–°: ä»Issuesç”ŸæˆHugoå†…å®¹"
            echo "æ¨é€å˜æ›´åˆ° $DEFAULT_BRANCH"
            git push origin $DEFAULT_BRANCH
          else
            echo "æ— å˜æ›´å¯æäº¤"
          fi

      - name: è§¦å‘Hugoæ„å»º
        if: steps.convert.outputs.needs_build == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # è°ƒç”¨ä»“åº“åˆ†å‘äº‹ä»¶
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "hugo-build-trigger"}'
